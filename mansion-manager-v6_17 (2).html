<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ãƒãƒ³ã‚·ãƒ§ãƒ³ç®¡ç†å°å¸³</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=Shippori+Mincho:wght@400;700&display=swap" rel="stylesheet">
<style>
:root {
  --ink:#1a1410; --paper:#f5f0e8; --red:#c0392b; --blue:#2c5f8a;
  --light:#e8e0d0; --mid:#b8a898; --white:#fdfaf5;
  --green:#27ae60; --orange:#e67e22; --purple:#8e44ad;
}
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'Noto Sans JP',sans-serif;background:var(--paper);color:var(--ink);min-height:100vh;
  background-image:repeating-linear-gradient(0deg,transparent,transparent 39px,rgba(0,0,0,0.05) 39px,rgba(0,0,0,0.05) 40px);}

/* HEADER */
header{background:var(--ink);color:var(--paper);padding:12px 18px;display:flex;align-items:center;
  justify-content:space-between;position:sticky;top:0;z-index:100;box-shadow:0 3px 16px rgba(0,0,0,0.3);gap:8px;flex-wrap:wrap;}
header h1{font-family:'Shippori Mincho',serif;font-size:1.05rem;letter-spacing:.12em;white-space:nowrap;}
header h1 span{color:var(--red);margin-right:4px;}
.hdr-right{display:flex;align-items:center;gap:10px;}
.sync-wrap{display:flex;align-items:center;gap:5px;font-size:.73rem;color:var(--mid);}
.sync-dot{width:7px;height:7px;border-radius:50%;background:var(--mid);transition:background .3s;flex-shrink:0;}
.sync-dot.ok{background:var(--green);}
.sync-dot.loading{background:#f39c12;animation:blink 1s infinite;}
.sync-dot.error{background:var(--red);}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}
.badge{background:var(--red);color:#fff;padding:3px 10px;border-radius:20px;font-size:.76rem;font-weight:700;white-space:nowrap;}

/* CONTAINER */
.wrap{max-width:760px;margin:0 auto;padding:18px 12px 50px;}
.info-note{border-left:3px solid var(--blue);padding:9px 13px;font-size:.79rem;margin-bottom:14px;
  background:rgba(44,95,138,.07);color:var(--blue);line-height:1.6;}

/* TOOLBAR */
.toolbar{display:flex;gap:7px;margin-bottom:13px;flex-wrap:wrap;}
.btn{display:inline-flex;align-items:center;gap:5px;border:none;padding:9px 14px;
  font-family:'Noto Sans JP',sans-serif;font-size:.83rem;font-weight:500;cursor:pointer;transition:all .18s;white-space:nowrap;}
.btn-blue{background:var(--blue);color:#fff;} .btn-blue:hover{background:#234f75;}
.btn-green{background:var(--green);color:#fff;} .btn-green:hover{background:#1e9150;}
.btn-ghost{background:none;color:var(--mid);border:1px solid var(--light);} .btn-ghost:hover{color:var(--ink);border-color:var(--mid);}
.btn-orange{background:var(--orange);color:#fff;} .btn-orange:hover{background:#ca6f1e;}
.btn-purple{background:var(--purple);color:#fff;} .btn-purple:hover{background:#7d3c98;}

/* TEST PANEL */
#testPanel{display:none;background:var(--ink);color:#e8e0d0;padding:13px 15px;font-family:monospace;
  font-size:.75rem;line-height:1.9;margin-bottom:13px;border-left:4px solid var(--purple);white-space:pre-wrap;word-break:break-all;}

/* SEARCH */
.search{width:100%;border:1px solid var(--light);border-bottom:2px solid var(--mid);background:var(--white);
  padding:10px 12px;font-family:'Noto Sans JP',sans-serif;font-size:.93rem;color:var(--ink);
  outline:none;margin-bottom:13px;transition:border-color .2s;}
.search:focus{border-bottom-color:var(--blue);}
.search::placeholder{color:var(--mid);}

/* CARDS */
.grid{display:grid;gap:8px;}
.card{background:var(--white);border-left:4px solid var(--ink);box-shadow:3px 3px 0 rgba(0,0,0,.07);
  transition:transform .14s,box-shadow .14s;animation:fadeIn .25s ease;}
@keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
.card:hover{transform:translateY(-2px);box-shadow:4px 6px 0 rgba(0,0,0,.11);}
.card-main{display:flex;align-items:center;justify-content:space-between;padding:11px 14px;gap:8px;}
.card-left{display:flex;flex-direction:column;gap:3px;min-width:0;flex:1;}
.card-name-row{display:flex;align-items:center;gap:5px;}
.card-name{font-family:'Shippori Mincho',serif;font-size:.96rem;letter-spacing:.05em;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.duty{font-size:.88rem;flex-shrink:0;display:none;} .duty.on{display:inline;}
.card-tel{font-size:.86rem;color:var(--blue);font-weight:500;}
.card-btns{display:flex;align-items:center;gap:5px;flex-shrink:0;}
.ic{background:none;border:1px solid var(--light);color:var(--mid);width:26px;height:26px;
  display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:.77rem;transition:all .17s;}
.ic:hover{border-color:var(--mid);color:var(--ink);}
.ic.del:hover{background:var(--red);border-color:var(--red);color:#fff;}
.card-detail{display:none;border-top:1px solid var(--light);padding:11px 14px;grid-template-columns:1fr 1fr;gap:9px;}
.il{font-size:.64rem;font-weight:700;letter-spacing:.12em;color:var(--mid);text-transform:uppercase;margin-bottom:2px;}
.iv{font-size:.85rem;color:var(--ink);}
.iv.tel{color:var(--blue);font-weight:500;}
.age{font-size:.7rem;color:var(--mid);font-weight:500;}
.age.old{color:var(--red);}
.sched-list{display:flex;flex-direction:column;gap:4px;}
.sched-row{display:flex;gap:4px;align-items:center;flex-wrap:wrap;}
.dtag{font-size:.67rem;font-weight:700;padding:2px 4px;background:var(--ink);color:#fff;}
.dtag.sat{background:var(--blue);} .dtag.sun{background:var(--red);}
.sched-time{font-size:.79rem;}
.pdf-list{display:flex;flex-direction:column;gap:6px;}
.pdf-row{display:flex;align-items:center;gap:5px;flex-wrap:wrap;}
.pdf-name{font-size:.82rem;flex:1;min-width:50px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.pbtn{display:inline-flex;align-items:center;gap:2px;border:none;padding:3px 8px;
  font-family:'Noto Sans JP',sans-serif;font-size:.69rem;font-weight:700;cursor:pointer;transition:background .17s;white-space:nowrap;text-decoration:none;}
.pbtn.prev{background:var(--blue);color:#fff;} .pbtn.prev:hover{background:#234f75;}
.pbtn.dl{background:var(--ink);color:#fff;} .pbtn.dl:hover{background:var(--red);}
.empty{text-align:center;padding:60px 20px;color:var(--mid);}
.empty .icon{font-size:2.4rem;margin-bottom:10px;opacity:.4;}
.empty p{font-family:'Shippori Mincho',serif;font-size:.93rem;letter-spacing:.1em;}

/* OVERLAY BASE */
.overlay{display:none;position:fixed;inset:0;background:rgba(26,20,16,.74);
  z-index:200;align-items:center;justify-content:center;backdrop-filter:blur(3px);}
.overlay.open{display:flex;}

/* MODAL */
.modal{background:var(--white);width:92%;max-width:600px;max-height:93vh;overflow-y:auto;
  border-top:4px solid var(--red);animation:slideIn .2s ease;}
@keyframes slideIn{from{transform:translateY(-14px);opacity:0}to{transform:translateY(0);opacity:1}}
.modal-hdr{display:flex;justify-content:space-between;align-items:center;padding:14px 20px 10px;
  border-bottom:1px solid var(--light);position:sticky;top:0;background:var(--white);z-index:10;}
.modal-hdr h2{font-family:'Shippori Mincho',serif;font-size:1rem;letter-spacing:.1em;}
.x-btn{background:none;border:none;font-size:1.2rem;cursor:pointer;color:var(--mid);transition:color .2s;}
.x-btn:hover{color:var(--red);}
.modal-body{padding:16px 20px;}
.modal-foot{display:flex;gap:9px;padding:2px 20px 20px;}
.fg{margin-bottom:15px;}
.fg>label{display:block;font-size:.7rem;font-weight:700;letter-spacing:.1em;color:var(--blue);margin-bottom:6px;text-transform:uppercase;}
.fi{width:100%;border:none;border-bottom:2px solid var(--mid);background:transparent;padding:7px 3px;
  font-family:'Noto Sans JP',sans-serif;font-size:.92rem;color:var(--ink);outline:none;transition:border-color .2s;}
.fi:focus{border-bottom-color:var(--blue);background:rgba(44,95,138,.04);}
textarea.fi{resize:vertical;min-height:64px;border:1px solid var(--light);border-bottom:2px solid var(--mid);
  padding:7px 5px;font-size:.87rem;line-height:1.6;}
textarea.fi:focus{border-bottom-color:var(--blue);}
.sel{flex:1;border:none;border-bottom:2px solid var(--mid);background:transparent;padding:7px 3px;
  font-family:'Noto Sans JP',sans-serif;font-size:.88rem;color:var(--ink);outline:none;cursor:pointer;
  appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%23b8a898'/%3E%3C/svg%3E");
  background-repeat:no-repeat;background-position:right 4px center;padding-right:18px;transition:border-color .2s;}
.sel:focus{border-bottom-color:var(--blue);}
.date-row{display:flex;align-items:center;gap:8px;}
.date-lbl{font-size:.81rem;color:var(--mid);flex-shrink:0;}
.btn-save{flex:1;background:var(--ink);color:var(--paper);border:none;padding:12px;
  font-family:'Noto Sans JP',sans-serif;font-size:.87rem;font-weight:700;letter-spacing:.1em;cursor:pointer;transition:background .2s;}
.btn-save:hover{background:var(--red);}
.btn-cancel{background:none;color:var(--mid);border:1px solid var(--light);padding:12px 16px;
  font-family:'Noto Sans JP',sans-serif;font-size:.83rem;cursor:pointer;transition:all .2s;}
.btn-cancel:hover{border-color:var(--mid);color:var(--ink);}

/* SCHEDULE EDITOR */
.sched-ed{display:flex;flex-direction:column;gap:9px;}
.sched-item{border:1px solid var(--light);background:rgba(245,240,232,.5);padding:11px 11px 9px;}
.sched-hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:7px;}
.sched-num{font-size:.69rem;font-weight:700;color:var(--mid);letter-spacing:.1em;}
.sched-del{background:none;border:none;color:var(--mid);cursor:pointer;font-size:.81rem;padding:2px 4px;transition:color .2s;}
.sched-del:hover{color:var(--red);}
.days-row{display:flex;gap:4px;flex-wrap:wrap;margin-bottom:8px;}
.dcb{display:none;}
.dlbl{display:inline-flex;align-items:center;justify-content:center;width:32px;height:32px;
  border:1.5px solid var(--light);font-size:.79rem;font-weight:700;cursor:pointer;transition:all .12s;user-select:none;color:var(--mid);}
.dcb:checked+.dlbl{background:var(--ink);color:var(--paper);border-color:var(--ink);}
.dcb[data-t="sat"]:checked+.dlbl{background:var(--blue);border-color:var(--blue);}
.dcb[data-t="sun"]:checked+.dlbl{background:var(--red);border-color:var(--red);}
.time-row{display:flex;align-items:center;gap:7px;}
.time-sep{color:var(--mid);font-weight:700;flex-shrink:0;}
.tsel{flex:1;border:none;border-bottom:2px solid var(--mid);background:transparent;padding:5px 2px;
  font-family:'Noto Sans JP',sans-serif;font-size:.88rem;color:var(--ink);outline:none;cursor:pointer;
  appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%23b8a898'/%3E%3C/svg%3E");
  background-repeat:no-repeat;background-position:right 4px center;padding-right:18px;transition:border-color .2s;}
.tsel:focus{border-bottom-color:var(--blue);}
.dash-btn{background:none;border:1.5px dashed var(--mid);color:var(--mid);width:100%;padding:8px;
  font-family:'Noto Sans JP',sans-serif;font-size:.81rem;cursor:pointer;transition:all .2s;letter-spacing:.04em;margin-top:3px;}
.dash-btn:hover{border-color:var(--blue);color:var(--blue);}
.dash-btn:disabled{opacity:.35;cursor:not-allowed;}

/* PDF EDITOR */
.pdf-ed{display:flex;flex-direction:column;gap:7px;}
.pdf-item{border:1px solid var(--light);background:rgba(245,240,232,.5);padding:9px 11px;
  display:grid;grid-template-columns:1fr auto;gap:7px;align-items:start;}
.pdf-fields{display:flex;flex-direction:column;gap:5px;}
.pfi{width:100%;border:none;border-bottom:1.5px solid var(--mid);background:transparent;padding:5px 2px;
  font-family:'Noto Sans JP',sans-serif;font-size:.85rem;color:var(--ink);outline:none;transition:border-color .2s;}
.pfi:focus{border-bottom-color:var(--blue);}
.pfi::placeholder{color:var(--mid);font-size:.79rem;}
.pdf-del{background:none;border:none;color:var(--mid);cursor:pointer;font-size:.94rem;padding:3px 5px;transition:color .2s;align-self:center;}
.pdf-del:hover{color:var(--red);}

/* LOCK MODELS */
.model-wrap{display:flex;flex-wrap:wrap;gap:6px;padding:4px 0;}
.mcb{display:none;}
.mlbl{display:inline-flex;align-items:center;border:1.5px solid var(--light);padding:5px 10px;
  font-size:.81rem;cursor:pointer;color:var(--mid);transition:all .13s;user-select:none;}
.mcb:checked+.mlbl{background:var(--ink);color:var(--paper);border-color:var(--ink);}

/* GAS CONFIG MODAL */
.cfg-overlay{display:none;position:fixed;inset:0;background:rgba(26,20,16,.74);
  z-index:200;align-items:center;justify-content:center;backdrop-filter:blur(3px);}
.cfg-overlay.open{display:flex;}
.cfg-modal{background:var(--white);width:92%;max-width:520px;max-height:90vh;overflow-y:auto;
  border-top:4px solid var(--green);animation:slideIn .2s ease;padding:22px;}
.cfg-modal h2{font-family:'Shippori Mincho',serif;font-size:1rem;margin-bottom:16px;letter-spacing:.08em;}
.cfg-label{font-size:.72rem;font-weight:700;letter-spacing:.1em;color:var(--blue);text-transform:uppercase;display:block;margin-bottom:7px;}
.cfg-input{width:100%;border:none;border-bottom:2px solid var(--mid);background:transparent;
  padding:8px 3px;font-family:monospace;font-size:.82rem;color:var(--ink);outline:none;margin-bottom:12px;transition:border-color .2s;}
.cfg-input:focus{border-bottom-color:var(--green);}
.cfg-input::placeholder{color:var(--mid);}
.gas-toggle{background:none;border:1px solid var(--light);color:var(--mid);width:100%;
  padding:8px 12px;font-family:'Noto Sans JP',sans-serif;font-size:.8rem;cursor:pointer;text-align:left;transition:all .2s;}
.gas-toggle:hover{border-color:var(--mid);color:var(--ink);}
.gas-block{display:none;margin-top:10px;}
.gas-block.open{display:block;}
.gas-block ol{font-size:.81rem;padding-left:17px;line-height:2.1;margin-bottom:10px;color:var(--ink);}
.gas-code{background:var(--ink);color:#e8e0d0;padding:12px 14px;font-family:monospace;
  font-size:.71rem;line-height:1.75;overflow-x:auto;white-space:pre;}

/* MERGE DIALOG */
.merge-overlay{display:none;position:fixed;inset:0;background:rgba(26,20,16,.78);z-index:400;align-items:center;justify-content:center;}
.merge-overlay.open{display:flex;}
.merge-box{background:var(--white);width:92%;max-width:500px;border-top:4px solid var(--orange);padding:22px;animation:slideIn .2s ease;}
.merge-box h3{font-family:'Shippori Mincho',serif;font-size:1rem;margin-bottom:10px;letter-spacing:.08em;}
.merge-box p{font-size:.83rem;color:var(--ink);margin-bottom:14px;line-height:1.7;}
.merge-diff{background:rgba(230,126,34,.07);border-left:3px solid var(--orange);padding:10px 12px;
  font-size:.79rem;color:var(--ink);margin-bottom:16px;line-height:1.9;}
.merge-acts{display:flex;gap:8px;flex-wrap:wrap;}
.m-merge{flex:1;background:var(--orange);color:#fff;border:none;padding:11px;
  font-family:'Noto Sans JP',sans-serif;font-size:.85rem;font-weight:700;cursor:pointer;min-width:100px;}
.m-merge:hover{background:#ca6f1e;}
.m-new{background:var(--ink);color:var(--paper);border:none;padding:11px 14px;
  font-family:'Noto Sans JP',sans-serif;font-size:.83rem;cursor:pointer;}
.m-new:hover{background:var(--red);}
.m-cancel{background:none;color:var(--mid);border:1px solid var(--light);padding:11px 12px;
  font-family:'Noto Sans JP',sans-serif;font-size:.81rem;cursor:pointer;}
.m-cancel:hover{border-color:var(--mid);color:var(--ink);}

/* PDF PREVIEW */
.pdf-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.88);z-index:300;
  flex-direction:column;align-items:center;justify-content:center;gap:10px;padding:14px;}
.pdf-overlay.open{display:flex;}
.pdf-bar{display:flex;align-items:center;justify-content:space-between;width:100%;max-width:920px;}
.pdf-ttl{color:#f5f0e8;font-size:.9rem;font-family:'Shippori Mincho',serif;}
.pdf-acts{display:flex;gap:8px;}
.pdf-dl{display:inline-block;background:var(--ink);color:#f5f0e8;padding:6px 14px;
  font-family:'Noto Sans JP',sans-serif;font-size:.8rem;text-decoration:none;transition:background .2s;}
.pdf-dl:hover{background:var(--red);}
.pdf-close{background:none;border:1px solid rgba(255,255,255,.25);color:#f5f0e8;padding:6px 14px;
  font-family:'Noto Sans JP',sans-serif;font-size:.8rem;cursor:pointer;}
.pdf-close:hover{background:rgba(255,255,255,.1);}
.pdf-frame{width:100%;max-width:920px;flex:1;border:none;background:#fff;}

/* TOAST */
.toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(20px);
  background:var(--ink);color:var(--paper);padding:10px 20px;font-size:.84rem;
  opacity:0;transition:all .3s;pointer-events:none;z-index:500;white-space:nowrap;}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0);}
</style>
</head>
<body>

<header>
  <h1><span>â–®</span>ãƒãƒ³ã‚·ãƒ§ãƒ³ç®¡ç†å°å¸³</h1>
  <div class="hdr-right">
    <div class="sync-wrap">
      <div class="sync-dot" id="syncDot"></div>
      <span id="syncLabel">èµ·å‹•ä¸­â€¦</span>
    </div>
    <div class="badge" id="countBadge">0 ä»¶</div>
  </div>
</header>

<div class="wrap">
  <div class="info-note" id="infoNote">ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ã¯ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ä¸­ã€‚Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¨é€£æºã™ã‚‹ã«ã¯ã€Œâš™ GASè¨­å®šã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã€‚</div>

  <div class="toolbar">
    <button class="btn btn-blue"   onclick="openModal()">ï¼‹ æ–°è¦ç™»éŒ²</button>
    <button class="btn btn-green"  onclick="exportCSV()">ğŸ“Š CSVæ›¸ãå‡ºã—</button>
    <button class="btn btn-ghost"  onclick="syncToSheets()">â˜ æ‰‹å‹•åŒæœŸ</button>
    <button class="btn btn-orange" onclick="openCfg()">âš™ GASè¨­å®š</button>
    <button class="btn btn-purple" onclick="runTest()">ğŸ”¬ æ¥ç¶šãƒ†ã‚¹ãƒˆ</button>
  </div>

  <div id="testPanel"></div>
  <input class="search" type="text" id="searchInput" placeholder="ğŸ”ã€€ãƒãƒ³ã‚·ãƒ§ãƒ³åãƒ»ç®¡ç†ä¼šç¤¾ãƒ»ä½æ‰€ã§æ¤œç´¢â€¦" oninput="renderCards()">
  <div class="grid" id="cardsGrid"></div>
</div>

<!-- ç™»éŒ²ãƒ»ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="overlay" id="modalOverlay">
  <div class="modal">
    <div class="modal-hdr">
      <h2 id="modalTitle">æ–°è¦ç™»éŒ²</h2>
      <button class="x-btn" onclick="closeModal()">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="fg"><label>â‘  ãƒãƒ³ã‚·ãƒ§ãƒ³å</label>
        <input class="fi" type="text" id="f_name" placeholder="ä¾‹ï¼šã‚°ãƒ©ãƒ³ãƒ‰ãƒ‘ãƒ¬ã‚¹æ–°å®¿"></div>
      <div class="fg"><label>â‘¡ ç®¡ç†å®¤ã®é›»è©±ç•ªå·</label>
        <input class="fi" type="tel" id="f_room_tel" placeholder="ä¾‹ï¼š03-1234-5678"></div>
      <div class="fg"><label>â‘¢ å‡ºå‹¤æ™‚é–“<span style="font-weight:400;opacity:.7;font-size:.85em">ï¼ˆè¤‡æ•°è¿½åŠ ã§ãã¾ã™ï¼‰</span></label>
        <div class="sched-ed" id="schedEd"></div>
        <button class="dash-btn" onclick="addSched()">ï¼‹ å‡ºå‹¤æ™‚é–“ã‚’è¿½åŠ </button></div>
      <div class="fg"><label>â‘£ ç®¡ç†ä¼šç¤¾å</label>
        <input class="fi" type="text" id="f_company" placeholder="ä¾‹ï¼šæ ªå¼ä¼šç¤¾ã€‡ã€‡ç®¡ç†"></div>
      <div class="fg"><label>â‘¤ ç®¡ç†ä¼šç¤¾ã®é›»è©±ç•ªå·</label>
        <input class="fi" type="tel" id="f_company_tel" placeholder="ä¾‹ï¼š03-9876-5432"></div>
      <div class="fg"><label>â‘¥ ä½æ‰€</label>
        <input class="fi" type="text" id="f_address" placeholder="ä¾‹ï¼šæ±äº¬éƒ½æ–°å®¿åŒºè¥¿æ–°å®¿1-1-1"></div>
      <div class="fg"><label>â‘¦ ç«£å·¥å¹´æœˆ</label>
        <div class="date-row">
          <select class="sel" id="f_year"></select>
          <span class="date-lbl">å¹´</span>
          <select class="sel" id="f_month">
            <option value="">æœˆã‚’é¸æŠ</option>
            <option value="1">1æœˆ</option><option value="2">2æœˆ</option><option value="3">3æœˆ</option>
            <option value="4">4æœˆ</option><option value="5">5æœˆ</option><option value="6">6æœˆ</option>
            <option value="7">7æœˆ</option><option value="8">8æœˆ</option><option value="9">9æœˆ</option>
            <option value="10">10æœˆ</option><option value="11">11æœˆ</option><option value="12">12æœˆ</option>
          </select>
          <span class="date-lbl">æœˆ</span>
        </div></div>
      <div class="fg"><label>â‘§ PDFè³‡æ–™<span style="font-weight:400;opacity:.7;font-size:.85em">ï¼ˆæœ€å¤§3ä»¶ãƒ»URLã‚’ç›´æ¥å…¥åŠ›ï¼‰</span></label>
        <div class="pdf-ed" id="pdfEd"></div>
        <button class="dash-btn" id="addPdfBtn" onclick="addPdf()">ï¼‹ PDFã‚’è¿½åŠ </button></div>
      <div class="fg"><label>â‘¨ éµãƒ¡ãƒ¼ã‚«ãƒ¼</label>
        <select class="sel" id="f_maker" onchange="onMakerChange()" style="width:100%">
          <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
          <option value="ç¾å’Œãƒ­ãƒƒã‚¯">ç¾å’Œãƒ­ãƒƒã‚¯</option>
          <option value="ã‚·ãƒ–ã‚¿ãƒ‹">ã‚·ãƒ–ã‚¿ãƒ‹</option>
          <option value="ã‚´ãƒ¼ãƒ«">ã‚´ãƒ¼ãƒ«</option>
        </select></div>
      <div class="fg" id="modelGrp" style="display:none"><label>â‘¨ æ©Ÿç¨®<span style="font-weight:400;opacity:.7;font-size:.85em">ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</span></label>
        <div class="model-wrap" id="f_models"></div></div>
      <div class="fg"><label>â‘© å‚™è€ƒ</label>
        <textarea class="fi" id="f_notes" placeholder="ä¾‹ï¼šç·Šæ€¥é€£çµ¡å…ˆãƒ»ç‰¹è¨˜äº‹é …ãªã©"></textarea></div>
    </div>
    <div class="modal-foot">
      <button class="btn-save" onclick="saveEntry()">ä¿å­˜ã™ã‚‹</button>
      <button class="btn-cancel" onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>
</div>

<!-- GASè¨­å®š -->
<div class="cfg-overlay" id="cfgOverlay">
  <div class="cfg-modal">
    <h2>âš™ Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆé€£æºè¨­å®š</h2>
    <span class="cfg-label">ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªURL</span>
    <input class="cfg-input" type="text" id="cfgUrl"
      autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"
      placeholder="https://script.google.com/macros/s/â€¦/exec">
    <div style="display:flex;gap:8px;margin-bottom:16px;">
      <button class="btn btn-green" style="flex:1" onclick="saveCfg()">âœ” ä¿å­˜ã—ã¦é–‰ã˜ã‚‹</button>
      <button class="btn btn-ghost" onclick="closeCfg()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
    <hr style="border:none;border-top:1px solid var(--light);margin-bottom:14px;">
    <button class="gas-toggle" id="gasToggle" onclick="toggleGas()">â–¶ åˆå›è¨­å®šæ‰‹é †ãƒ»GASã‚³ãƒ¼ãƒ‰ã‚’è¦‹ã‚‹</button>
    <div class="gas-block" id="gasBlock">
      <ol>
        <li>Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’æ–°è¦ä½œæˆ</li>
        <li>ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã€Œæ‹¡å¼µæ©Ÿèƒ½ã€â†’ã€ŒApps Scriptã€ã‚’é–‹ã</li>
        <li>æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã‚’å…¨å‰Šé™¤ã—ã€ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’è²¼ã‚Šä»˜ã‘ã‚‹</li>
        <li>ã€Œãƒ‡ãƒ—ãƒ­ã‚¤ã€â†’ã€Œæ–°ã—ã„ãƒ‡ãƒ—ãƒ­ã‚¤ã€â†’ã€Œã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã€ã‚’é¸æŠ</li>
        <li>ã€Œã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€ã‚’ <strong>å…¨å“¡</strong> ã«è¨­å®šã—ã¦ã€Œãƒ‡ãƒ—ãƒ­ã‚¤ã€</li>
        <li>è¡¨ç¤ºã•ã‚ŒãŸURLã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ä¸Šã®æ¬„ã«è²¼ã‚Šä»˜ã‘ã€ä¿å­˜</li>
      </ol>
      <div class="gas-code">// â”€â”€ æ›¸ãè¾¼ã¿ï¼ˆã‚¢ãƒ—ãƒªâ†’ã‚·ãƒ¼ãƒˆï¼‰ â”€â”€
function doPost(e) {
  try {
    const data = JSON.parse(e.postData.contents);
    if (data.action === 'sync') {
      const ss = SpreadsheetApp.getActiveSpreadsheet();
      const sh = ss.getSheetByName('å°å¸³') || ss.insertSheet('å°å¸³');
      sh.clearContents();
      const h = ['ãƒãƒ³ã‚·ãƒ§ãƒ³å','ç®¡ç†å®¤é›»è©±ç•ªå·','å‡ºå‹¤ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«',
        'ç®¡ç†ä¼šç¤¾å','ç®¡ç†ä¼šç¤¾é›»è©±ç•ªå·','ä½æ‰€','ç«£å·¥å¹´','ç«£å·¥æœˆ',
        'ç¯‰å¹´æ•°','éµãƒ¡ãƒ¼ã‚«ãƒ¼','æ©Ÿç¨®','PDFè³‡æ–™','å‚™è€ƒ',
        '_key','_schedules','_pdfs','_lock_models'];
      sh.appendRow(h);
      sh.getRange(1,1,1,h.length).setFontWeight('bold')
        .setBackground('#1a1410').setFontColor('#f5f0e8');
      data.rows.forEach(r => sh.appendRow(r));
      sh.autoResizeColumns(1, h.length);
      return out({ok:true, count:data.rows.length});
    }
    return out({ok:false, msg:'unknown action'});
  } catch(err) { return out({ok:false, msg:err.toString()}); }
}

// â”€â”€ èª­ã¿è¾¼ã¿ï¼ˆã‚·ãƒ¼ãƒˆâ†’ã‚¢ãƒ—ãƒªï¼‰ â”€â”€
function doGet(e) {
  try {
    const sh = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('å°å¸³');
    if (!sh || sh.getLastRow() <= 1) return out({ok:true, rows:[]});
    const rows = sh.getRange(2,1,sh.getLastRow()-1,sh.getLastColumn()).getValues();
    return out({ok:true, rows:rows});
  } catch(err) { return out({ok:false, msg:err.toString()}); }
}

function out(obj) {
  return ContentService.createTextOutput(JSON.stringify(obj))
    .setMimeType(ContentService.MimeType.JSON);
}</div>
    </div>
  </div>
</div>

<!-- é‡è¤‡çµ±åˆ -->
<div class="merge-overlay" id="mergeOverlay">
  <div class="merge-box">
    <h3>âš  åŒã˜ç‰©ä»¶åãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ</h3>
    <p id="mergeMsg"></p>
    <div class="merge-diff" id="mergeDiff"></div>
    <div class="merge-acts">
      <button class="m-merge"  onclick="doMerge()">çµ±åˆã—ã¦ä¸Šæ›¸ã</button>
      <button class="m-new"    onclick="doAddNew()">åˆ¥ç‰©ä»¶ã¨ã—ã¦è¿½åŠ </button>
      <button class="m-cancel" onclick="cancelMerge()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>
</div>

<!-- PDFãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
<div class="pdf-overlay" id="pdfOverlay">
  <div class="pdf-bar">
    <span class="pdf-ttl" id="pdfTitle"></span>
    <div class="pdf-acts">
      <a class="pdf-dl" id="pdfDl" href="#" target="_blank">â¬‡ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</a>
      <button class="pdf-close" onclick="closePdf()">âœ• é–‰ã˜ã‚‹</button>
    </div>
  </div>
  <iframe class="pdf-frame" id="pdfFrame" src="about:blank"></iframe>
</div>

<div class="toast" id="toast"></div>

<script>
'use strict';

// â”€â”€â”€ å®šæ•° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SK  = 'mansion_v6';
const GK  = 'mansion_gas_url';
const MAX_PDF = 3;
const DAYS = [
  {id:'mon',lbl:'æœˆ',t:'week'},{id:'tue',lbl:'ç«',t:'week'},
  {id:'wed',lbl:'æ°´',t:'week'},{id:'thu',lbl:'æœ¨',t:'week'},
  {id:'fri',lbl:'é‡‘',t:'week'},{id:'sat',lbl:'åœŸ',t:'sat'},
  {id:'sun',lbl:'æ—¥',t:'sun'},
];
const MODELS = {
  'ç¾å’Œãƒ­ãƒƒã‚¯':['Raccess','ãƒãƒ³ã‚¿ãƒƒãƒã‚­ãƒ¼','Raccessãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—',
    'å½©è¡£TLNT-K03APR(ä¸¸å½¢)','å½©è¡£TLNT-K04APR','FKLã‚«ãƒ¼ãƒ‰','æ¨™æº–ã‚­ãƒ¼'],
  'ã‚·ãƒ–ã‚¿ãƒ‹':[],'ã‚´ãƒ¼ãƒ«':[],
};

// â”€â”€â”€ çŠ¶æ…‹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let data   = [];
let editKey = null;
let pending = null, mergeKey = null;
let expanded = new Set();
let sc = 0; // schedCount

// â”€â”€â”€ åˆæœŸåŒ– â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(function(){
  const sel = document.getElementById('f_year');
  const now = new Date().getFullYear();
  sel.innerHTML = '<option value="">å¹´ã‚’é¸æŠ</option>';
  for(let y=now;y>=1950;y--) sel.innerHTML += `<option value="${y}">${y}å¹´</option>`;
})();

// â”€â”€â”€ ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function e(s){ if(s==null)return''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function toast(msg){ const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2800); }
function setStat(st,lbl){ document.getElementById('syncDot').className='sync-dot '+st; document.getElementById('syncLabel').textContent=lbl; }
function genKey(){ return Date.now().toString(36)+Math.random().toString(36).slice(2); }
function calcAge(y,m){ if(!y)return null; const now=new Date(); let a=now.getFullYear()-parseInt(y); if(m&&now.getMonth()+1<parseInt(m))a--; return a<0?0:a; }
function fmtDays(days){ return(days||[]).map(id=>DAYS.find(d=>d.id===id)?.lbl).filter(Boolean).join('ãƒ»'); }
function onDuty(entry){
  if(!entry.schedules?.length)return false;
  const now=new Date(); const dow=['sun','mon','tue','wed','thu','fri','sat'][now.getDay()];
  const hm=String(now.getHours()).padStart(2,'0')+':'+String(now.getMinutes()).padStart(2,'0');
  return entry.schedules.some(s=>s.days?.includes(dow)&&hm>=s.time_start&&hm<s.time_end);
}
function updNote(){
  const url=localStorage.getItem(GK); const n=document.getElementById('infoNote');
  if(url){ n.textContent='âœ… Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆé€£æºæ¸ˆã¿ã€‚èµ·å‹•æ™‚ã«è‡ªå‹•èª­ã¿è¾¼ã¿ãƒ»ç™»éŒ²ç·¨é›†å‰Šé™¤ã®ãŸã³ã«è‡ªå‹•æ›¸ãè¾¼ã¿ã•ã‚Œã¾ã™ã€‚';
    n.style.cssText='border-left-color:var(--green);background:rgba(39,174,96,.07);color:#1a6636;'; }
  else{ n.textContent='ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ã¯ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ä¸­ã€‚Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¨é€£æºã™ã‚‹ã«ã¯ã€Œâš™ GASè¨­å®šã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã€‚';
    n.style.cssText='border-left-color:var(--blue);background:rgba(44,95,138,.07);color:var(--blue);'; }
}

// â”€â”€â”€ ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadData(){
  const url=localStorage.getItem(GK);
  if(url){
    setStat('loading','èª­ã¿è¾¼ã¿ä¸­â€¦');
    try{
      const res=await fetch(url); const j=await res.json();
      if(j.ok&&Array.isArray(j.rows)&&j.rows.length>0){
        data=j.rows.map(rowToEntry);
        localStorage.setItem(SK,JSON.stringify(data));
        setStat('ok','ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆåŒæœŸæ¸ˆã¿');
        toast(`âœ” ${data.length}ä»¶ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`);
      } else { loadLocal(); }
    }catch{ loadLocal(); setStat('error','èª­ã¿è¾¼ã¿å¤±æ•—ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ã‚’ä½¿ç”¨ï¼‰'); }
  } else { loadLocal(); }
  renderCards();
}

function rowToEntry(r){
  let schedules=[],pdfs=[],lock_models=[];
  try{schedules=JSON.parse(r[14]||'[]');}catch{}
  try{pdfs=JSON.parse(r[15]||'[]');}catch{}
  try{lock_models=JSON.parse(r[16]||'[]');}catch{}
  return{
    _key:r[13]||genKey(), name:String(r[0]||''), room_tel:String(r[1]||''),
    schedules, company:String(r[3]||''), company_tel:String(r[4]||''),
    address:String(r[5]||''), comp_year:r[6]?String(r[6]):'', comp_month:r[7]?String(r[7]):'',
    lock_maker:String(r[9]||''), lock_models, pdfs, notes:String(r[12]||''),
  };
}
function loadLocal(){
  try{ const raw=localStorage.getItem(SK); data=raw?JSON.parse(raw):[]; setStat('ok','ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜'); }
  catch{ data=[]; setStat('ok','ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜'); }
}
function persist(){
  try{ localStorage.setItem(SK,JSON.stringify(data)); }
  catch{ toast('âš  ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ'); return; }
  const url=localStorage.getItem(GK); if(url) autoSync(url);
}

// â”€â”€â”€ GASåŒæœŸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function gasPost(url, body, timeoutMs=15000){
  const ctrl=new AbortController();
  const tid=setTimeout(()=>ctrl.abort(),timeoutMs);
  try{
    const res=await fetch(url,{method:'POST',headers:{'Content-Type':'text/plain'},body:JSON.stringify(body),signal:ctrl.signal});
    clearTimeout(tid);
    const txt=await res.text();
    // GASãŒèªè¨¼ã‚¨ãƒ©ãƒ¼ç­‰ã§HTMLã‚’è¿”ã™ã‚±ãƒ¼ã‚¹ã‚’æ¤œå‡º
    if(txt.trim().startsWith('<')){
      throw new Error('GASãŒHTMLã‚’è¿”ã—ã¾ã—ãŸã€‚ãƒ‡ãƒ—ãƒ­ã‚¤è¨­å®šã§ã€Œã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼šå…¨å“¡ã€ã«ãªã£ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
    }
    let j;
    try{ j=JSON.parse(txt); }
    catch{ throw new Error('ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒJSONå½¢å¼ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚GASã‚³ãƒ¼ãƒ‰ã‚’å†ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ãã ã•ã„ã€‚'); }
    return j;
  }catch(err){
    clearTimeout(tid);
    if(err.name==='AbortError') throw new Error('ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆ15ç§’ï¼‰ã€‚GAS URLã¾ãŸã¯ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
    throw err;
  }
}
async function autoSync(url){
  setStat('loading','åŒæœŸä¸­â€¦');
  try{
    const j=await gasPost(url,{action:'sync',rows:buildRows()});
    if(j.ok){ setStat('ok','ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆåŒæœŸæ¸ˆã¿'); }
    else{ throw new Error(j.msg||'GASã‚¨ãƒ©ãƒ¼ï¼ˆè©³ç´°ä¸æ˜ï¼‰'); }
  }catch(err){ setStat('error','åŒæœŸå¤±æ•—'); toast('âš  '+err.message); }
}
async function syncToSheets(){
  const url=localStorage.getItem(GK); if(!url){alert('GAS URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');return;}
  setStat('loading','åŒæœŸä¸­â€¦'); toast('â˜ é€ä¿¡ä¸­â€¦');
  try{
    const j=await gasPost(url,{action:'sync',rows:buildRows()});
    if(j.ok){ setStat('ok','ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆåŒæœŸæ¸ˆã¿'); toast(`âœ” ${j.count}ä»¶ã‚’åŒæœŸã—ã¾ã—ãŸ`); }
    else{ throw new Error(j.msg||'GASã‚¨ãƒ©ãƒ¼ï¼ˆè©³ç´°ä¸æ˜ï¼‰'); }
  }catch(err){
    setStat('error','åŒæœŸå¤±æ•—');
    const msg=err.message;
    // è©³ç´°ãªã‚¨ãƒ©ãƒ¼ã‚’ã‚¢ãƒ©ãƒ¼ãƒˆã§è¡¨ç¤º
    const hint=msg.includes('fetch')||msg.includes('Failed')?
      '\n\nã€å¯¾å‡¦æ³•ã€‘\nGASã‚’ã€Œæ–°ã—ã„ãƒ‡ãƒ—ãƒ­ã‚¤ã€ã§å†ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã€æ–°ã—ã„URLã‚’GASè¨­å®šã«è²¼ã‚Šç›´ã—ã¦ãã ã•ã„ã€‚':
      '';
    alert('âš  åŒæœŸã‚¨ãƒ©ãƒ¼\n\n'+msg+hint);
    toast('âš  åŒæœŸå¤±æ•—ï¼ˆè©³ç´°ã¯ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—å‚ç…§ï¼‰');
  }
}
function buildRows(){
  return data.map(d=>{
    const sc=(d.schedules||[]).map(s=>`${fmtDays(s.days)} ${s.time_start}ã€œ${s.time_end}`).join(' / ');
    const age=calcAge(d.comp_year,d.comp_month);
    const pdf=(d.pdfs||[]).map(p=>`${p.name}ï¼š${p.url}`).join(' | ');
    return[d.name||'',d.room_tel||'',sc,d.company||'',d.company_tel||'',d.address||'',
      d.comp_year||'',d.comp_month||'',age!=null?`ç¯‰${age}å¹´`:'',
      d.lock_maker||'',(d.lock_models||[]).join(' / '),pdf,d.notes||'',
      d._key||'',JSON.stringify(d.schedules||[]),JSON.stringify(d.pdfs||[]),JSON.stringify(d.lock_models||[])];
  });
}

// â”€â”€â”€ æ¥ç¶šãƒ†ã‚¹ãƒˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function runTest(){
  const panel=document.getElementById('testPanel'); panel.style.display='block';
  const url=localStorage.getItem(GK); let log='ğŸ”¬ ãƒ†ã‚¹ãƒˆé–‹å§‹...\n';
  if(!url){panel.textContent=log+'âŒ GAS URLãŒæœªè¨­å®šã§ã™ã€‚';return;}
  log+=`âœ… GAS URL: ${url}\n\n[1] GASç–é€šãƒ†ã‚¹ãƒˆï¼ˆGETï¼‰...\n`; panel.textContent=log;
  try{
    const res=await fetch(url); const txt=await res.text();
    log+=`  ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${res.status}\n  ãƒ¬ã‚¹ãƒãƒ³ã‚¹: ${txt.slice(0,150)}\n`;
    if(txt.trim().startsWith('<')){ log+='  âŒ HTMLãŒè¿”å´ã•ã‚Œã¾ã—ãŸ\n  â†’ ãƒ‡ãƒ—ãƒ­ã‚¤è¨­å®šã®ã€Œã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€ã‚’ã€Œå…¨å“¡ã€ã«ã—ã¦ãã ã•ã„\n'; panel.textContent=log; return; }
    try{ const j=JSON.parse(txt); log+=`  âœ… JSON OK: ${JSON.stringify(j)}\n`; }
    catch{ log+='  âš  JSONã§ã¯ãªã„ï¼ˆGASã‚³ãƒ¼ãƒ‰ã‚’å†ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ãã ã•ã„ï¼‰\n'; }
  }catch(err){ log+=`  âŒ ç–é€šå¤±æ•—: ${err.message}\n  â†’ URLã¾ãŸã¯ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ç¢ºèªã—ã¦ãã ã•ã„\n`; panel.textContent=log; return; }
  log+='\n[2] ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿é€ä¿¡ï¼ˆPOSTï¼‰...\n'; panel.textContent=log;
  try{
    const res=await fetch(url,{method:'POST',headers:{'Content-Type':'text/plain'},
      body:JSON.stringify({action:'sync',rows:[['ãƒ†ã‚¹ãƒˆç‰©ä»¶','00-0000-0000','æœˆç« 9:00ã€œ18:00',
        'ãƒ†ã‚¹ãƒˆç®¡ç†ä¼šç¤¾','00-0000-0001','æ±äº¬éƒ½ãƒ†ã‚¹ãƒˆåŒº','2000','4','ç¯‰25å¹´','','','','ãƒ†ã‚¹ãƒˆå‚™è€ƒ','test_key','[]','[]','[]']]})});
    const txt=await res.text(); log+=`  ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${res.status}\n  ãƒ¬ã‚¹ãƒãƒ³ã‚¹: ${txt.slice(0,200)}\n`;
    try{ const j=JSON.parse(txt); log+=j.ok?'  âœ… æ›¸ãè¾¼ã¿æˆåŠŸï¼ã‚·ãƒ¼ãƒˆã«ã€Œãƒ†ã‚¹ãƒˆç‰©ä»¶ã€ãŒè¿½åŠ ã•ã‚Œã¦ã„ã‚‹ã¯ãšã§ã™ã€‚\n':`  âŒ GASã‚¨ãƒ©ãƒ¼: ${j.msg}\n`; }
    catch{ log+='  âš  ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒJSONã§ã¯ãªã„\n  â†’ GASã‚³ãƒ¼ãƒ‰ã‚’å†ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ãã ã•ã„\n'; }
  }catch(err){ log+=`  âŒ é€ä¿¡å¤±æ•—: ${err.message}\n`; }
  log+='\nğŸ”¬ ãƒ†ã‚¹ãƒˆå®Œäº†\n'; panel.textContent=log;
}

// â”€â”€â”€ GASè¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openCfg(){ document.getElementById('cfgUrl').value=localStorage.getItem(GK)||''; document.getElementById('cfgOverlay').classList.add('open'); }
function closeCfg(){ document.getElementById('cfgOverlay').classList.remove('open'); }
function saveCfg(){
  const url=document.getElementById('cfgUrl').value.trim();
  if(url){ localStorage.setItem(GK,url); toast('âœ” GAS URLã‚’ä¿å­˜ã—ã¾ã—ãŸ'); updNote(); setStat('ok','GASé€£æºæ¸ˆã¿'); }
  closeCfg();
}
function toggleGas(){
  const b=document.getElementById('gasBlock'); const t=document.getElementById('gasToggle');
  b.classList.toggle('open');
  t.textContent=b.classList.contains('open')?'â–¼ åˆå›è¨­å®šæ‰‹é †ãƒ»GASã‚³ãƒ¼ãƒ‰ã‚’é–‰ã˜ã‚‹':'â–¶ åˆå›è¨­å®šæ‰‹é †ãƒ»GASã‚³ãƒ¼ãƒ‰ã‚’è¦‹ã‚‹';
}

// â”€â”€â”€ ç™»éŒ²ãƒ»ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openModal(key=null){
  editKey=key; sc=0;
  document.getElementById('modalOverlay').classList.add('open');
  clearSchedEd(); clearPdfEd();
  if(key!==null){
    const d=data.find(x=>x._key===key); if(!d)return;
    document.getElementById('modalTitle').textContent='ç·¨é›†';
    document.getElementById('f_name').value=d.name||'';
    document.getElementById('f_room_tel').value=d.room_tel||'';
    document.getElementById('f_company').value=d.company||'';
    document.getElementById('f_company_tel').value=d.company_tel||'';
    document.getElementById('f_address').value=d.address||'';
    document.getElementById('f_notes').value=d.notes||'';
    document.getElementById('f_year').value=d.comp_year||'';
    document.getElementById('f_month').value=d.comp_month||'';
    document.getElementById('f_maker').value=d.lock_maker||'';
    onMakerChange(d.lock_models||[]);
    (d.schedules?.length?d.schedules:[null]).forEach(s=>addSched(s));
    (d.pdfs||[]).forEach(p=>addPdf(p));
  } else {
    document.getElementById('modalTitle').textContent='æ–°è¦ç™»éŒ²';
    ['f_name','f_room_tel','f_company','f_company_tel','f_address','f_notes'].forEach(id=>document.getElementById(id).value='');
    document.getElementById('f_year').value=''; document.getElementById('f_month').value='';
    document.getElementById('f_maker').value=''; document.getElementById('f_models').innerHTML='';
    document.getElementById('modelGrp').style.display='none';
    addSched();
  }
  updPdfBtn();
}
function closeModal(){ document.getElementById('modalOverlay').classList.remove('open'); editKey=null; }

// â”€â”€â”€ ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚¨ãƒ‡ã‚£ã‚¿ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function timeOpts(sel){
  let h=''; for(let i=0;i<24;i++) for(let m=0;m<60;m+=30){
    const v=String(i).padStart(2,'0')+':'+String(m).padStart(2,'0');
    h+=`<option value="${v}"${v===sel?' selected':''}>${v}</option>`; } return h;
}
function addSched(s=null){
  const ed=document.getElementById('schedEd'); const idx=sc++;
  const days=s?s.days:[]; const ts=s?s.time_start:'09:00'; const te=s?s.time_end:'18:00';
  const dh=DAYS.map(d=>`<input class="dcb" type="checkbox" id="d_${idx}_${d.id}" data-t="${d.t}" ${days.includes(d.id)?'checked':''}><label class="dlbl" for="d_${idx}_${d.id}">${d.lbl}</label>`).join('');
  const div=document.createElement('div');
  div.innerHTML=`<div class="sched-item" data-sid="${idx}">
    <div class="sched-hdr"><span class="sched-num">ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</span><button class="sched-del" onclick="this.closest('.sched-item').remove()">âœ• å‰Šé™¤</button></div>
    <div class="days-row">${dh}</div>
    <div class="time-row"><select class="tsel" id="ts_${idx}">${timeOpts(ts)}</select><span class="time-sep">ã€œ</span><select class="tsel" id="te_${idx}">${timeOpts(te)}</select></div>
  </div>`;
  ed.appendChild(div.firstElementChild);
}
function clearSchedEd(){ document.getElementById('schedEd').innerHTML=''; }
function collectScheds(){
  return Array.from(document.querySelectorAll('#schedEd .sched-item')).map(item=>{
    const sid=item.dataset.sid;
    const days=DAYS.filter(d=>item.querySelector(`#d_${sid}_${d.id}`)?.checked).map(d=>d.id);
    return{days,time_start:item.querySelector(`#ts_${sid}`)?.value||'09:00',time_end:item.querySelector(`#te_${sid}`)?.value||'18:00'};
  }).filter(s=>s.days.length>0);
}

// â”€â”€â”€ PDFã‚¨ãƒ‡ã‚£ã‚¿ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addPdf(p=null){
  const ed=document.getElementById('pdfEd'); if(ed.children.length>=MAX_PDF)return;
  const item=document.createElement('div'); item.className='pdf-item';
  item.innerHTML=`<div class="pdf-fields">
    <input class="pfi pn" type="text" placeholder="è³‡æ–™åï¼ˆä¾‹ï¼šç®¡ç†è¦ç´„ï¼‰" value="${e(p?.name||'')}">
    <input class="pfi pu" type="text" placeholder="URLï¼ˆDropboxã¾ãŸã¯Googleãƒ‰ãƒ©ã‚¤ãƒ–ï¼‰" value="${e(p?.url||'')}">
  </div><button class="pdf-del" onclick="this.closest('.pdf-item').remove();updPdfBtn()">âœ•</button>`;
  ed.appendChild(item); updPdfBtn();
}
function updPdfBtn(){ const n=document.getElementById('pdfEd').children.length; document.getElementById('addPdfBtn').disabled=n>=MAX_PDF; }
function clearPdfEd(){ document.getElementById('pdfEd').innerHTML=''; updPdfBtn(); }
function collectPdfs(){
  return Array.from(document.querySelectorAll('#pdfEd .pdf-item')).map(i=>({name:i.querySelector('.pn').value.trim(),url:i.querySelector('.pu').value.trim()})).filter(p=>p.url);
}

// â”€â”€â”€ éµãƒ¡ãƒ¼ã‚«ãƒ¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function onMakerChange(sel=[]){
  const maker=document.getElementById('f_maker').value;
  const grp=document.getElementById('modelGrp'); const con=document.getElementById('f_models');
  const models=MODELS[maker]||[];
  if(maker&&models.length>0){
    con.innerHTML=models.map((m,i)=>`<input class="mcb" type="checkbox" id="mc_${i}" value="${e(m)}" ${sel.includes(m)?'checked':''}><label class="mlbl" for="mc_${i}">${e(m)}</label>`).join('');
    grp.style.display='block';
  } else { con.innerHTML=''; grp.style.display='none'; }
}
function collectModels(){ return Array.from(document.querySelectorAll('#f_models .mcb:checked')).map(c=>c.value); }

// â”€â”€â”€ ä¿å­˜ãƒ»å‰Šé™¤ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildEntry(){
  return{
    _key:editKey||genKey(), name:document.getElementById('f_name').value.trim(),
    room_tel:document.getElementById('f_room_tel').value.trim(),
    schedules:collectScheds(), company:document.getElementById('f_company').value.trim(),
    company_tel:document.getElementById('f_company_tel').value.trim(),
    address:document.getElementById('f_address').value.trim(),
    comp_year:document.getElementById('f_year').value, comp_month:document.getElementById('f_month').value,
    lock_maker:document.getElementById('f_maker').value, lock_models:collectModels(),
    pdfs:collectPdfs(), notes:document.getElementById('f_notes').value.trim(),
  };
}
function saveEntry(){
  const name=document.getElementById('f_name').value.trim();
  if(!name){alert('ãƒãƒ³ã‚·ãƒ§ãƒ³åã¯å¿…é ˆã§ã™ã€‚');return;}
  const entry=buildEntry();
  if(editKey===null){
    const dup=data.find(x=>x.name.trim()===name);
    if(dup){
      pending=entry; mergeKey=dup._key;
      const flds=[{key:'room_tel',lbl:'ç®¡ç†å®¤é›»è©±ç•ªå·'},{key:'company',lbl:'ç®¡ç†ä¼šç¤¾å'},
        {key:'company_tel',lbl:'ç®¡ç†ä¼šç¤¾é›»è©±ç•ªå·'},{key:'address',lbl:'ä½æ‰€'},{key:'notes',lbl:'å‚™è€ƒ'}]
        .filter(f=>(dup[f.key]||'')!==(entry[f.key]||''));
      document.getElementById('mergeMsg').textContent=`ã€Œ${name}ã€ã¯ã™ã§ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™ã€‚å†…å®¹ã‚’çµ±åˆã—ã¾ã™ã‹ï¼Ÿ`;
      document.getElementById('mergeDiff').innerHTML=flds.length
        ?'<strong>å¤‰æ›´ã•ã‚Œã‚‹é …ç›®ï¼š</strong><br>'+flds.map(f=>`${f.lbl}ï¼š${dup[f.key]||'ï¼ˆç©ºï¼‰'} â†’ ${entry[f.key]||'ï¼ˆç©ºï¼‰'}`).join('<br>')
        :'é …ç›®ã®å·®ç•°ã¯ã‚ã‚Šã¾ã›ã‚“ï¼ˆã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ»PDFç­‰ãŒæ›´æ–°ã•ã‚Œã¾ã™ï¼‰ã€‚';
      document.getElementById('mergeOverlay').classList.add('open');
      return;
    }
  }
  commit(entry);
}
function doMerge(){
  if(!pending||!mergeKey)return;
  const i=data.findIndex(x=>x._key===mergeKey);
  if(i>=0){pending._key=mergeKey;data[i]=pending;}
  cancelMerge(); persist(); renderCards(); closeModal(); toast('âœ” çµ±åˆã—ã¦ä¿å­˜ã—ã¾ã—ãŸ');
}
function doAddNew(){
  if(!pending)return; pending._key=genKey(); data.push(pending);
  cancelMerge(); persist(); renderCards(); closeModal(); toast('âœ” åˆ¥ç‰©ä»¶ã¨ã—ã¦ç™»éŒ²ã—ã¾ã—ãŸ');
}
function cancelMerge(){ pending=null; mergeKey=null; document.getElementById('mergeOverlay').classList.remove('open'); }
function commit(entry){
  if(editKey!==null){ const i=data.findIndex(x=>x._key===editKey); if(i>=0)data[i]=entry; }
  else{ data.push(entry); }
  persist(); renderCards(); closeModal(); toast(editKey!==null?'âœ” æ›´æ–°ã—ã¾ã—ãŸ':'âœ” ç™»éŒ²ã—ã¾ã—ãŸ');
}
function deleteEntry(key){
  const d=data.find(x=>x._key===key);
  if(!d||!confirm(`ã€Œ${d.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`))return;
  data=data.filter(x=>x._key!==key); persist(); renderCards(); toast('ğŸ—‘ å‰Šé™¤ã—ã¾ã—ãŸ');
}

// â”€â”€â”€ æç”» â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function schedHTML(scheds){
  if(!scheds?.length)return'â€”';
  return scheds.map(s=>{
    const tags=(s.days||[]).map(id=>{const d=DAYS.find(x=>x.id===id);return d?`<span class="dtag ${d.t}">${d.lbl}</span>`:''}).join('');
    return`<div class="sched-row">${tags}<span class="sched-time">${e(s.time_start)}ã€œ${e(s.time_end)}</span></div>`;
  }).join('');
}
function toggleDetail(key){ expanded.has(key)?expanded.delete(key):expanded.add(key); renderCards(); }
function renderCards(){
  const q=document.getElementById('searchInput').value.trim().toLowerCase();
  const grid=document.getElementById('cardsGrid');
  document.getElementById('countBadge').textContent=`${data.length} ä»¶`;
  const filtered=data.filter(d=>!q||d.name.toLowerCase().includes(q)||(d.address||'').toLowerCase().includes(q)||(d.company||'').toLowerCase().includes(q));
  if(!data.length){ grid.innerHTML='<div class="empty"><div class="icon">ğŸ¢</div><p>ã¾ã ç™»éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚<br>ã€Œæ–°è¦ç™»éŒ²ã€ã‹ã‚‰è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</p></div>'; return; }
  if(!filtered.length){ grid.innerHTML='<div class="empty"><p>è©²å½“ã™ã‚‹ãƒãƒ³ã‚·ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚</p></div>'; return; }
  grid.innerHTML=filtered.map(d=>{
    const duty=onDuty(d); const exp=expanded.has(d._key);
    const age=calcAge(d.comp_year,d.comp_month);
    const ageBadge=age!=null?`<span class="age${age>=30?' old':''}">&nbsp;ç¯‰${age}å¹´</span>`:'';
    const compDate=d.comp_year?`${d.comp_year}å¹´${d.comp_month?d.comp_month+'æœˆ':''}ç«£å·¥${ageBadge}`:'';
    const rows=[
      d.schedules?.length?`<div class="info-item" style="grid-column:1/-1"><div class="il">å‡ºå‹¤æ™‚é–“</div><div class="sched-list">${schedHTML(d.schedules)}</div></div>`:'',
      compDate?`<div class="info-item" style="grid-column:1/-1"><div class="il">ç«£å·¥å¹´æœˆ</div><div class="iv">${compDate}</div></div>`:'',
      d.lock_maker?`<div class="info-item"><div class="il">éµãƒ¡ãƒ¼ã‚«ãƒ¼</div><div class="iv">ğŸ”‘ ${e(d.lock_maker)}</div></div>`:'',
      d.lock_models?.length?`<div class="info-item"><div class="il">æ©Ÿç¨®</div><div class="iv">${d.lock_models.map(m=>`<span style="display:inline-block;background:var(--ink);color:var(--paper);font-size:.71rem;padding:2px 6px;margin:2px 2px 0 0">${e(m)}</span>`).join('')}</div></div>`:'',
      d.company?`<div class="info-item"><div class="il">ç®¡ç†ä¼šç¤¾å</div><div class="iv">${e(d.company)}</div></div>`:'',
      d.company_tel?`<div class="info-item"><div class="il">ç®¡ç†ä¼šç¤¾é›»è©±ç•ªå·</div><div class="iv tel">${e(d.company_tel)}</div></div>`:'',
      d.address?`<div class="info-item" style="grid-column:1/-1"><div class="il">ä½æ‰€</div><div class="iv">${e(d.address)}</div></div>`:'',
      d.pdfs?.length?`<div class="info-item" style="grid-column:1/-1"><div class="il">PDFè³‡æ–™</div><div class="pdf-list">${d.pdfs.map(p=>`<div class="pdf-row"><span>ğŸ“„</span><span class="pdf-name">${e(p.name)}</span><button class="pbtn prev" onclick="openPdf('${e(p.name)}','${e(p.url)}')">ğŸ‘ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</button><a class="pbtn dl" href="${e(p.url)}" target="_blank">â¬‡ DL</a></div>`).join('')}</div></div>`:'',
      d.notes?`<div class="info-item" style="grid-column:1/-1"><div class="il">å‚™è€ƒ</div><div class="iv" style="white-space:pre-wrap;font-size:.83rem">${e(d.notes)}</div></div>`:'',
    ].filter(Boolean).join('');
    return`<div class="card">
      <div class="card-main">
        <div class="card-left">
          <div class="card-name-row"><span class="duty${duty?' on':''}">ğŸŸ¢</span><span class="card-name">ğŸ¢ ${e(d.name)}</span></div>
          <div class="card-tel">${e(d.room_tel)||'é›»è©±ç•ªå·æœªç™»éŒ²'}</div>
        </div>
        <div class="card-btns">
          <button class="ic" onclick="toggleDetail('${d._key}')" title="è©³ç´°">${exp?'â–²':'â–¼'}</button>
          <button class="ic" onclick="openModal('${d._key}')" title="ç·¨é›†">âœ</button>
          <button class="ic del" onclick="deleteEntry('${d._key}')" title="å‰Šé™¤">âœ•</button>
        </div>
      </div>
      ${exp&&rows?`<div class="card-detail" style="display:grid">${rows}</div>`:''}
    </div>`;
  }).join('');
}

// â”€â”€â”€ CSV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function exportCSV(){
  const hdr=['ãƒãƒ³ã‚·ãƒ§ãƒ³å','ç®¡ç†å®¤é›»è©±ç•ªå·','å‡ºå‹¤ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«','ç®¡ç†ä¼šç¤¾å','ç®¡ç†ä¼šç¤¾é›»è©±ç•ªå·','ä½æ‰€','ç«£å·¥å¹´','ç«£å·¥æœˆ','ç¯‰å¹´æ•°','éµãƒ¡ãƒ¼ã‚«ãƒ¼','æ©Ÿç¨®','PDFè³‡æ–™','å‚™è€ƒ'];
  const rows=data.map(d=>{
    const sc=(d.schedules||[]).map(s=>`${fmtDays(s.days)} ${s.time_start}ã€œ${s.time_end}`).join(' / ');
    const age=calcAge(d.comp_year,d.comp_month);
    const pdf=(d.pdfs||[]).map(p=>`${p.name}ï¼š${p.url}`).join(' | ');
    return[d.name||'',d.room_tel||'',sc,d.company||'',d.company_tel||'',d.address||'',d.comp_year||'',d.comp_month||'',age!=null?`ç¯‰${age}å¹´`:'',d.lock_maker||'',(d.lock_models||[]).join(' / '),pdf,d.notes||''].map(v=>`"${String(v).replace(/"/g,'""')}"`);
  });
  const csv='\uFEFF'+[hdr.map(h=>`"${h}"`), ...rows].map(r=>r.join(',')).join('\r\n');
  const a=Object.assign(document.createElement('a'),{href:URL.createObjectURL(new Blob([csv],{type:'text/csv;charset=utf-8;'})),download:'ãƒãƒ³ã‚·ãƒ§ãƒ³ç®¡ç†å°å¸³_'+new Date().toLocaleDateString('ja-JP').replace(/\//g,'-')+'.csv'});
  a.click(); URL.revokeObjectURL(a.href); toast('ğŸ“Š CSVã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ');
}

// â”€â”€â”€ PDFãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openPdf(name,url){
  let v=url;
  if(url.includes('dropbox.com')) v=url.replace('www.dropbox.com','dl.dropboxusercontent.com').replace(/\?dl=[01]/,'');
  else if(url.includes('drive.google.com/file/d/')){const m=url.match(/\/d\/([^/?]+)/);if(m)v=`https://drive.google.com/file/d/${m[1]}/preview`;}
  document.getElementById('pdfTitle').textContent=name;
  document.getElementById('pdfDl').href=url;
  document.getElementById('pdfFrame').src=v;
  document.getElementById('pdfOverlay').classList.add('open');
}
function closePdf(){ document.getElementById('pdfOverlay').classList.remove('open'); document.getElementById('pdfFrame').src='about:blank'; }

// â”€â”€â”€ ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('modalOverlay').addEventListener('click',function(ev){if(ev.target===this)closeModal();});
document.getElementById('cfgOverlay').addEventListener('click',function(ev){if(ev.target===this)closeCfg();});
document.getElementById('pdfOverlay').addEventListener('click',function(ev){if(ev.target===this)closePdf();});

// â”€â”€â”€ èµ·å‹• â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
updNote();
loadData();
setInterval(renderCards,60000);
</script>
</body>
</html>
